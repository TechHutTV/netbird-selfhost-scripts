# NetBird Self-Hosted with PocketID

This guide walks you through deploying NetBird self-hosted with [PocketID](https://github.com/pocket-id/pocket-id) as the identity provider and automatic SSL via NGINX and Let's Encrypt.

## Required DNS Records

Before starting, create the following **A records** pointing to your server's IP address:

| Subdomain | Purpose | Required |
|-----------|---------|----------|
| `netbird.yourdomain.com` | NetBird Dashboard, Management API, Signal, and Relay | Yes |
| `auth.yourdomain.com` | PocketID authentication server | Yes |

**Example:** If your server IP is `203.0.113.50` and your domain is `example.com`:

```
netbird.example.com    A    203.0.113.50
auth.example.com       A    203.0.113.50
```

> **Note:** DNS propagation can take a few minutes to several hours. Verify your records are resolving before running the setup script using `dig netbird.yourdomain.com` or an online DNS checker.

---

## Quick Start (Recommended)

The easiest way to get started is using our interactive setup script:

```bash
# Clone the repository
git clone https://github.com/TechHutTV/netbird-selfhost-scripts.git
cd netbird-selfhost-scripts

# Run the interactive setup
./setup.sh
```

The setup script will:
- Check prerequisites (Docker, Docker Compose, certbot, etc.)
- Walk you through domain and PocketID configuration
- Generate secure secrets automatically
- Obtain SSL certificates from Let's Encrypt
- Configure NGINX reverse proxy automatically
- Update all configuration files
- Optionally start the services

### Setup Script Options

```bash
./setup.sh                    # Interactive setup wizard
./setup.sh --update-pocketid  # Update PocketID credentials after initial setup
./setup.sh --reset            # Reset all configuration to defaults
./setup.sh --check            # Check prerequisites only
./setup.sh --help             # Show help
```

---

## Manual Setup

If you prefer to configure everything manually, follow the steps below.

### File Structure

```
netbird-selfhost-scripts/
├── setup.sh            # Interactive setup script (recommended)
├── compose.yaml        # Docker Compose stack definition
├── .env                # Main environment variables (domains, secrets)
├── dashboard.env       # NetBird Dashboard configuration (OIDC settings)
├── relay.env           # NetBird Relay server configuration
├── management.json     # NetBird Management server configuration
├── turnserver.conf     # Coturn TURN/STUN server configuration
├── nginx/              # NGINX configuration
│   ├── nginx.conf      # Main NGINX config
│   └── conf.d/         # Site configurations (generated by setup.sh)
└── README.md           # This documentation
```

#### Configuration Files Overview

| File | Purpose | Key Settings |
|------|---------|--------------|
| `setup.sh` | Interactive setup wizard | Automates all configuration |
| `.env` | Main environment variables | Domain names, TURN password, relay secret |
| `dashboard.env` | Dashboard web UI config | OIDC client ID, auth endpoints |
| `relay.env` | Relay server config | Exposed address, auth secret |
| `management.json` | Management API config | STUN/TURN servers, OIDC, IDP integration |
| `turnserver.conf` | Coturn config | Ports, credentials, realm |
| `compose.yaml` | Docker services | All container definitions |
| `nginx/` | Reverse proxy config | SSL, routing, WebSocket, gRPC |

### Overview

| Component | Purpose |
|-----------|---------|
| NGINX | Reverse proxy with automatic SSL via Let's Encrypt |
| Certbot | SSL certificate management and auto-renewal |
| PocketID | Lightweight OIDC identity provider |
| NetBird Dashboard | Web UI for managing your network |
| NetBird Management | Core management API server |
| NetBird Signal | Signaling server for peer connections |
| NetBird Relay | Relay server for fallback connectivity |
| Coturn | TURN/STUN server for NAT traversal |

### Prerequisites

- Docker and Docker Compose installed
- certbot installed (for SSL certificates)
- A domain name with DNS configured (2 subdomains required)
- Ports 80, 443, 3478 (UDP), and 49152-65535 (UDP) available

### DNS Configuration

Create the following DNS A records pointing to your server IP:

| Subdomain | Purpose |
|-----------|---------|
| `netbird.example.com` | NetBird Dashboard & API |
| `auth.example.com` | PocketID authentication |

### Setup Instructions

#### Step 1: Clone and Navigate

```bash
# Clone the repository
git clone https://github.com/TechHutTV/netbird-selfhost-scripts.git
cd netbird-selfhost-scripts
```

#### Step 2: Generate Secrets

Generate secure passwords for TURN and relay authentication:

```bash
# Generate TURN password
openssl rand -base64 32

# Generate relay auth secret (use a different value)
openssl rand -base64 32
```

#### Step 3: Update Configuration Files

All configuration files are ready to use - just update the placeholder values with your domain and secrets.

**Quick Setup (Optional):** Use `sed` to replace all placeholder domains at once:

```bash
# Set your domains
NETBIRD_DOMAIN="netbird.yourdomain.com"
POCKETID_DOMAIN="auth.yourdomain.com"

# Replace in all config files
sed -i "s/netbird.example.com/$NETBIRD_DOMAIN/g" .env dashboard.env relay.env management.json turnserver.conf
sed -i "s/auth.example.com/$POCKETID_DOMAIN/g" .env dashboard.env management.json
```

Then manually update the secrets (TURN password, relay secret) - these must be unique values.

#### `.env` (Main environment variables)

```bash
# Domain Configuration
NETBIRD_DOMAIN=netbird.example.com
POCKETID_DOMAIN=auth.example.com
POCKETID_URL=https://auth.example.com
LETSENCRYPT_EMAIL=your-email@example.com

# Generate these with: openssl rand -base64 32
TURN_PASSWORD=your-turn-password-here
RELAY_AUTH_SECRET=your-relay-secret-here
```

#### `dashboard.env`

```bash
# Endpoints
NETBIRD_MGMT_API_ENDPOINT=https://netbird.example.com
NETBIRD_MGMT_GRPC_API_ENDPOINT=https://netbird.example.com

# OIDC Configuration (update after PocketID setup)
AUTH_AUDIENCE=your-pocketid-client-id
AUTH_CLIENT_ID=your-pocketid-client-id
AUTH_AUTHORITY=https://auth.example.com
USE_AUTH0=false
AUTH_SUPPORTED_SCOPES=openid profile email groups offline_access
AUTH_REDIRECT_URI=/auth
AUTH_SILENT_REDIRECT_URI=/silent-auth

# Token Configuration
NETBIRD_TOKEN_SOURCE=idToken

# SSL
NGINX_SSL_PORT=443
LETSENCRYPT_DOMAIN=none
```

#### `relay.env`

```bash
NB_LOG_LEVEL=info
NB_LISTEN_ADDRESS=:80
NB_EXPOSED_ADDRESS=rels://netbird.example.com:443/relay
NB_AUTH_SECRET=your-relay-secret-here
```

#### `turnserver.conf`

Update the credentials and realm:

```conf
# Update the password (must match TURN_PASSWORD in .env)
user=netbird:your-turn-password-here

# Update the realm to your domain
realm=netbird.example.com
```

#### `management.json`

Update the following values (search and replace `example.com` with your domain):

| Field | Update to |
|-------|-----------|
| `Stuns[0].URI` | `stun:YOUR_NETBIRD_DOMAIN:3478` |
| `Relay.Addresses` | `rels://YOUR_NETBIRD_DOMAIN:443/relay` |
| `Relay.Secret` | Your relay auth secret (same as `.env`) |
| `Signal.URI` | `YOUR_NETBIRD_DOMAIN:443` |
| `HttpConfig.AuthIssuer` | Your PocketID URL |
| `HttpConfig.AuthAudience` | PocketID Client ID (after Step 6) |
| `HttpConfig.OIDCConfigEndpoint` | `YOUR_POCKETID_URL/.well-known/openid-configuration` |
| `IdpManagerConfig.Extra.ManagementEndpoint` | Your PocketID URL |
| `IdpManagerConfig.Extra.ApiToken` | PocketID API Key (after Step 6) |
| `PKCEAuthorizationFlow.ProviderConfig.Audience` | PocketID Client ID |
| `PKCEAuthorizationFlow.ProviderConfig.ClientID` | PocketID Client ID |

#### Step 4: Obtain SSL Certificates

Obtain SSL certificates from Let's Encrypt using certbot:

```bash
# Make sure port 80 is available (stop any web servers)
sudo systemctl stop nginx 2>/dev/null || true
sudo systemctl stop apache2 2>/dev/null || true

# Obtain certificates for both domains
sudo certbot certonly --standalone -d netbird.yourdomain.com -d auth.yourdomain.com --email your-email@example.com --agree-tos --non-interactive
```

#### Step 5: Configure NGINX

Create the NGINX configuration directory and generate the config:

```bash
mkdir -p nginx/conf.d
```

The setup script generates `nginx/conf.d/netbird.conf` automatically. For manual setup, see the template in `nginx/netbird.conf.template`.

Key routes configured by NGINX:

| Path | Target | Protocol |
|------|--------|----------|
| `/` | dashboard:80 | HTTP |
| `/api` | management:80 | HTTP |
| `/signalexchange.SignalExchange/` | signal:80 | gRPC |
| `/management.ManagementService/` | management:80 | gRPC |
| `/ws-proxy/signal` | signal:80 | WebSocket |
| `/ws-proxy/management` | management:80 | WebSocket |
| `/relay` | relay:80 | WebSocket |

#### Step 6: Start the Stack

```bash
# Start all services
docker compose up -d
```

#### Step 7: Configure PocketID

1. Access PocketID at `https://auth.example.com`
2. Complete the initial setup wizard
3. Create an admin account

#### Create OIDC Client for NetBird

1. Go to **Admin** > **OIDC Clients**
2. Click **Create Client**
3. Configure:
   - **Name**: NetBird
   - **Client Launch URL**: `https://netbird.example.com`
   - **Callback URLs**:
     - `http://localhost:53000`
     - `https://netbird.example.com/auth`
     - `https://netbird.example.com/silent-auth`
   - **Logout Callback URL**: `https://netbird.example.com/`
   - **Public Client**: On
   - **PKCE**: On
4. Click **Save** and copy the **Client ID**

#### Create API Key for NetBird Management

1. Go to **Admin** > **API Keys**
2. Click **Add API Key**
3. Configure:
   - **Name**: NetBird Management
   - **Expires At**: Pick a date in the future
4. Click **Save** and copy the **API Key**

#### Step 8: Update Configuration with PocketID Client ID and API Key

> **Tip:** You can also use `./setup.sh --update-pocketid` to update these credentials interactively.

Update `dashboard.env`:
```bash
AUTH_AUDIENCE=your-client-id-from-pocketid
AUTH_CLIENT_ID=your-client-id-from-pocketid
```

Update `management.json`:
- Replace all `your-pocketid-client-id` with the Client ID from PocketID
- Replace `your-pocketid-api-token-here` with the API Key from PocketID
- Update the `ManagementEndpoint` in `IdpManagerConfig.Extra` to your PocketID URL

#### Step 9: Restart Services

```bash
docker compose restart dashboard management
```

### Verification

1. Access `https://netbird.example.com`
2. Click **Login** - you should be redirected to PocketID
3. Login with your PocketID credentials
4. You should be redirected back to the NetBird dashboard

---

## Connecting Clients

### Using the CLI

```bash
# Install NetBird client
curl -fsSL https://pkgs.netbird.io/install.sh | sh

# Connect with SSO
netbird up --management-url https://netbird.example.com
```

### Using Setup Keys

1. In the NetBird dashboard, go to **Setup Keys**
2. Create a new setup key
3. Use it to connect clients:

```bash
netbird up --management-url https://netbird.example.com --setup-key YOUR_SETUP_KEY
```

## Firewall Requirements

Ensure the following ports are open:

| Port | Protocol | Purpose |
|------|----------|---------|
| 80 | TCP | HTTP (Let's Encrypt, redirects to HTTPS) |
| 443 | TCP | HTTPS, WebSocket, gRPC |
| 3478 | UDP | STUN |
| 5349 | TCP | TURN over TLS |
| 49152-65535 | UDP | TURN relay ports |

For UFW (Ubuntu), run:
```bash
sudo ufw allow 80/tcp && sudo ufw allow 443/tcp && sudo ufw allow 3478/udp && \
sudo ufw allow 5349/tcp && sudo ufw allow 49152:65535/udp && sudo ufw reload
```

## SSL Certificate Renewal

The certbot container automatically renews certificates. You can also manually renew:

```bash
# Check certificate status
docker compose exec certbot certbot certificates

# Force renewal
docker compose exec certbot certbot renew --force-renewal

# Reload NGINX after renewal
docker compose exec nginx nginx -s reload
```

Certbot checks for renewal every 12 hours and will renew certificates that expire within 30 days.

## Data Persistence

Docker volumes store persistent data:

| Volume | Purpose | Backup Priority |
|--------|---------|-----------------|
| `letsencrypt_certs` | SSL certificates | Medium |
| `pocketid_data` | PocketID users, OIDC clients | High |
| `netbird_management` | NetBird peers, networks, ACLs | High |

### Backup

```bash
# Stop services
docker compose stop

# Backup volumes
docker run --rm -v netbird-selfhost-scripts_pocketid_data:/data -v $(pwd):/backup alpine \
    tar czf /backup/pocketid-backup.tar.gz -C /data .
docker run --rm -v netbird-selfhost-scripts_netbird_management:/data -v $(pwd):/backup alpine \
    tar czf /backup/netbird-backup.tar.gz -C /data .

# Restart services
docker compose start
```

## Troubleshooting

### Check service logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f management
docker compose logs -f pocketid
docker compose logs -f nginx
```

### Common Issues

**OIDC Configuration Error**
- Verify PocketID is accessible at the configured URL
- Check that client IDs match in all configuration files
- Ensure callback URLs exactly match (including trailing slashes)

**Connection Timeouts**
- Verify firewall rules allow required ports
- Check that DNS records resolve correctly
- Ensure SSL certificates are valid: `docker compose exec certbot certbot certificates`

**Management API Errors**
- Check `management.json` syntax with `jq . management.json`
- Verify the OIDC configuration endpoint is accessible

**NGINX Errors**
- Check NGINX logs: `docker compose logs nginx`
- Test config: `docker compose exec nginx nginx -t`
- Verify SSL certificates exist in `/etc/letsencrypt/live/`

## Architecture Diagram

```
                                    ┌─────────────────────────────────────────┐
                                    │              Internet                    │
                                    └─────────────────┬───────────────────────┘
                                                      │
                              ┌───────────────────────┼───────────────────────┐
                              │                       │                       │
                           TCP 80               TCP 443               UDP 3478
                                                                     UDP 49152-65535
                              │                       │                       │
                              ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    NGINX (:80, :443)                                     │
│                                                                                          │
│   Routes:                                                                                │
│   • auth.example.com     → pocketid:80                                                  │
│   • netbird.example.com/ → dashboard:80                                                 │
│   • /api                 → management:80                                                │
│   • /relay               → relay:80 (WebSocket)                                         │
│   • /signalexchange.*    → signal:80 (gRPC)                                            │
│   • /management.*        → management:80 (gRPC)                                         │
│   • /ws-proxy/*          → signal/management:80 (WebSocket)                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┬──────────────────────┐
         │                    │                    │                      │
         ▼                    ▼                    ▼                      ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    PocketID     │  │    Dashboard    │  │   Management    │  │     Signal      │
│    (IDP)        │  │    (Web UI)     │  │    (API)        │  │   (Signaling)   │
│    :80          │  │    :80          │  │    :80          │  │    :80          │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
                                                   │
                                                   ▼
                                          ┌─────────────────┐
                                          │     Relay       │
                                          │  (Fallback)     │
                                          │     :80         │
                                          └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                 Coturn (host network)                                   │
│                                                                                          │
│   UDP 3478 (STUN)  •  TCP 5349 (TURN TLS)  •  UDP 49152-65535 (relay ports)            │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Configuration Relationships

Understanding how the configuration files relate to each other:

```
.env
 ├── NETBIRD_DOMAIN ──────────────► Used in: dashboard.env, relay.env, management.json, turnserver.conf
 ├── POCKETID_URL ────────────────► Used in: dashboard.env, management.json
 ├── TURN_PASSWORD ───────────────► Must match: turnserver.conf (user=netbird:PASSWORD)
 └── RELAY_AUTH_SECRET ───────────► Must match: relay.env (NB_AUTH_SECRET)
                                              management.json (Relay.Secret)
```

**Important:** Ensure these values are synchronized across files:
- `TURN_PASSWORD` in `.env` must match the password in `turnserver.conf`
- `RELAY_AUTH_SECRET` in `.env` must match `NB_AUTH_SECRET` in `relay.env` AND `Relay.Secret` in `management.json`
- PocketID Client ID must be the same in `dashboard.env` (AUTH_CLIENT_ID, AUTH_AUDIENCE) and `management.json` (HttpConfig.AuthAudience, PKCEAuthorizationFlow.ProviderConfig)

## References

- [NetBird Documentation](https://docs.netbird.io/)
- [PocketID Documentation](https://github.com/pocket-id/pocket-id)
- [NGINX Documentation](https://nginx.org/en/docs/)
- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
